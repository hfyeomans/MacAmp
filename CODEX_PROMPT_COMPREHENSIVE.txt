================================================================================
CODEX DEEP CODEBASE ANALYSIS: DOUBLE DIGIT SUPERIMPOSITION ROOT CAUSE
================================================================================

CRITICAL FINDINGS SO FAR:
- Xcode console shows: digit(0) → DIGIT_0_EX logged 4 TIMES per frame
- This means SimpleSpriteImage.body is being evaluated 4x
- Adding .id() modifier did NOT fix the visual doubles
- Clearing DerivedData and .build did NOT fix it
- Fresh Xcode build initially works, then breaks

VERIFIED NOT THE CAUSE:
✅ MAIN_WINDOW_BACKGROUND does NOT contain pre-rendered digits (forensically verified)
✅ MainWindowView.swift is NOT being rendered (only in Preview)
✅ Sprite aliasing code has been removed (no DIGIT_0 aliases created)
✅ buildTimeDisplay() is only called once in view hierarchy
✅ No Text(":") views rendering colons

OBJECTIVE:
Find the EXACT code path causing 4 Image(nsImage:) instances to render for each digit
on screen, creating the visual superimposition the user is seeing.

================================================================================
ANALYSIS TASKS
================================================================================

TASK 1: TRACE THE RENDERING PIPELINE
-------------------------------------
Start at: MacAmpApp/Views/WinampMainWindow.swift line 257 (buildTimeDisplay)

Follow the execution path:
1. buildTimeDisplay() creates ZStack with 4 SimpleSpriteImage(.digit()) calls
2. Each SimpleSpriteImage.body evaluates (lines 41-93)
3. SpriteResolver.resolve() is called (SpriteResolver.swift line 109)
4. Image(nsImage:) is created (SimpleSpriteImage.swift line 68)

Question: At which step does 1 digit become 4 rendered images?

Check for:
- ForEach loops creating duplicate views
- Multiple .overlay() or .background() modifiers
- ZStack layering issues
- .transition() or .animation() creating ghost views

TASK 2: INVESTIGATE THE .onChange HANDLER
------------------------------------------
File: MacAmpApp/Views/WinampMainWindow.swift line 307-310

Current code:
```swift
.onChange(of: audioPlayer.currentTime) { _, _ in
    // Force SwiftUI to re-evaluate buildTimeDisplay() when currentTime changes
    // This ensures digit sprites update visually as the track plays
}
```

Questions:
- Why is the handler EMPTY but has a comment about forcing re-evaluation?
- Does an empty .onChange() cause SwiftUI to render multiple times?
- Should this be removed entirely?
- Is this triggering 4 render passes?

TASK 3: EXAMINE SimpleSpriteImage BODY EVALUATION
--------------------------------------------------
File: MacAmpApp/Views/Components/SimpleSpriteImage.swift lines 41-93

The body property creates a closure for resolution, then renders. Check:

1. Is the closure ({...})() being called multiple times?
2. Does the if-let chain create multiple code paths?
3. Is Image(nsImage:) being instantiated in multiple branches?
4. Does .id() modifier cause re-renders instead of preventing them?

Try removing .id() and see if that changes behavior.

TASK 4: CHECK FOR VIEW DUPLICATION IN ZSTACK
---------------------------------------------
File: MacAmpApp/Views/WinampMainWindow.swift line 258

The buildTimeDisplay() returns:
```swift
ZStack(alignment: .leading) {
    // 4 SimpleSpriteImage(.digit()) calls + 1 .character(58)
}
.at(Coords.timeDisplay)
.contentShape(Rectangle())
.onTapGesture { ... }
.onChange(of: audioPlayer.currentTime) { ... }
```

Questions:
- Does .at() create multiple offset layers?
- Does .contentShape() duplicate the view?
- Does .onTapGesture create a copy for hit testing?
- Does .onChange create a wrapper view that duplicates content?

TASK 5: INVESTIGATE SWIFTUI VIEW IDENTITY
------------------------------------------
When a digit changes (e.g., 0 → 1), SwiftUI needs to know if it's:
A) The SAME view with new content (update in place)
B) A DIFFERENT view (remove old, add new)

Current code has NO .id() on SimpleSpriteImage calls in buildTimeDisplay.

Check if adding .id() to the SimpleSpriteImage CALL fixes it:
```swift
SimpleSpriteImage(.digit(digits[0]), width: 9, height: 13)
    .id("digit-minute-tens-\(digits[0])")  // ← Add here instead
    .offset(x: 6, y: 0)
```

TASK 6: CHECK FOR PERSISTENT STATE
-----------------------------------
Theory: Old digit views remain in memory when currentTime updates.

Search for:
- @State variables that might hold old views
- View caching mechanisms
- Retained closures holding old sprites

Check files:
- MacAmpApp/Views/WinampMainWindow.swift (all @State variables)
- MacAmpApp/ViewModels/AudioPlayer.swift (@Published properties)

TASK 7: COMPARE WORKING VS BROKEN COMMITS
------------------------------------------
The user says "fresh build works, then breaks after running".

Compare:
```bash
git show 7e8629d:MacAmpApp/Views/WinampMainWindow.swift > /tmp/before.swift
git show HEAD:MacAmpApp/Views/WinampMainWindow.swift > /tmp/after.swift
diff /tmp/before.swift /tmp/after.swift
```

Look for ANY changes in:
- buildTimeDisplay() function
- .onChange handlers
- View modifiers
- ZStack structure

TASK 8: ANALYZE SKIN.IMAGES DICTIONARY
---------------------------------------
Theory: The Skin.images dictionary contains BOTH DIGIT_0 and DIGIT_0_EX even though
aliasing code is removed.

Add this logging to SkinManager.swift after line 433:
```swift
NSLog("=== CHECKING FOR DIGIT DUPLICATES ===")
let digitSprites = extractedImages.keys.filter { $0.contains("DIGIT") }.sorted()
for sprite in digitSprites {
    NSLog("  - \(sprite)")
}
NSLog("=====================================")
```

Then load Internet Archive skin and check console.

TASK 9: EXAMINE SWIFTUI RENDERING BEHAVIOR
-------------------------------------------
Four body evaluations is normal for SwiftUI (layout, render, update, etc).
But 4 VISIBLE images on screen is NOT normal.

Hypothesis: Each render pass is creating a NEW Image that persists.

Check:
- Does Image(nsImage:) retain the image in a cache?
- Are animations creating transition layers?
- Is there a blend mode issue making images semi-transparent and overlapping?

Add to Image rendering:
```swift
Image(nsImage: image)
    .interpolation(.none)
    .antialiased(false)
    .frame(width: width, height: height)
    .id("\(spriteName)-\(ObjectIdentifier(image))")
    .drawingGroup()  // ← Force rendering to single layer
```

TASK 10: CHECK FOR LAYOUT DUPLICATION
--------------------------------------
The time display uses .offset() for positioning. Check if offset creates layers:

```swift
SimpleSpriteImage(.digit(digits[0]), width: 9, height: 13)
    .offset(x: 6, y: 0)  // ← Does this create multiple layers?
```

Try replacing with .position():
```swift
SimpleSpriteImage(.digit(digits[0]), width: 9, height: 13)
    .position(x: 6, y: 6.5)  // position is absolute, not relative
```

================================================================================
SEARCH COMMANDS TO RUN
================================================================================

# 1. Find all SimpleSpriteImage instantiations
grep -rn "SimpleSpriteImage(.digit\|SimpleSpriteImage(.character\|SimpleSpriteImage(.minus" \
  MacAmpApp/Views --include="*.swift"

# 2. Find all .onChange handlers that might trigger re-renders
grep -rn "\.onChange(of: audioPlayer\.currentTime)" MacAmpApp --include="*.swift"

# 3. Check for duplicate buildTimeDisplay calls
grep -rn "buildTimeDisplay()" MacAmpApp/Views --include="*.swift"

# 4. Find all .id() modifiers
grep -rn "\.id(" MacAmpApp/Views --include="*.swift"

# 5. Check for view duplication in ZStack
grep -B5 -A10 "buildTimeDisplay\|buildFullWindow" MacAmpApp/Views/WinampMainWindow.swift

================================================================================
EXPECTED DELIVERABLE
================================================================================

Provide a detailed report containing:

1. ROOT CAUSE STATEMENT
   "The double digits are caused by [EXACT REASON] in [FILE:LINE]"

2. CODE EVIDENCE
   Show the specific code creating the duplicates

3. EXPLANATION
   Why does fresh build work but then break?
   Why does it affect all skins?
   Why 4 renders instead of 1?

4. THE FIX
   Exact code changes with before/after examples

5. WHY THIS FIX WORKS
   Architectural explanation

6. VERIFICATION STEPS
   How to test that doubles are gone

================================================================================
PRIORITY AREAS TO INVESTIGATE
================================================================================

HIGH PRIORITY:
1. SimpleSpriteImage.body closure evaluation (why 4x?)
2. .onChange(of: audioPlayer.currentTime) handler (is empty onChange bad?)
3. Skin.images dictionary contents (DIGIT_0 + DIGIT_0_EX both present?)

MEDIUM PRIORITY:
4. ZStack layering in buildTimeDisplay
5. SwiftUI view identity and caching
6. .offset() vs .position() behavior

LOW PRIORITY:
7. Blend modes and transparency
8. Animation/transition artifacts
9. Memory retention of old views

================================================================================
TESTING SCENARIOS
================================================================================

After finding the fix, test:

A. FRESH LAUNCH TEST:
   - Launch app
   - Load Classic Winamp
   - Play audio
   - Expected: Single digits incrementing
   - Check: Do doubles appear after N seconds?

B. SKIN SWITCH TEST:
   - Start with Classic (working)
   - Switch to Internet Archive
   - Expected: Single white digits
   - Check: Do doubles appear?

C. STATE CHANGE TEST:
   - While playing, pause/resume multiple times
   - Toggle remaining time display
   - Expected: No accumulation of digit layers

D. RELOAD TEST:
   - Switch to different skin
   - Switch back to Internet Archive
   - Expected: Still single digits, no accumulation

================================================================================
ADDITIONAL CONTEXT
================================================================================

Recent commit that might be relevant:
- 7e8629d: "fix(rendering): use skin bitmaps for sliders + fix digit updates"
  - Added .onChange(of: audioPlayer.currentTime) to force re-render
  - Removed Text(":") and replaced with CHARACTER_58 sprite

Architecture just implemented:
- SpriteResolver: Maps .digit(0) → "DIGIT_0_EX" or "DIGIT_0"
- SimpleSpriteImage: Supports both legacy ("DIGIT_0") and semantic (.digit(0))
- Removed sprite aliasing that created DIGIT_0 copies

User reports:
- Works fresh, breaks after running
- Affects time display, volume, balance, EQ, preamp
- Double colons in all skins
- One set increments, one static

Screenshot evidence:
- See "Screenshot 2025-10-12 at 5.41.58 PM.png"
- Shows clear double 0's superimposed

================================================================================
